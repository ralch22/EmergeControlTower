<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <title>Emerge Digital Control Tower</title>
    <meta property="og:title" content="Emerge Digital Control Tower" />
    <meta property="og:description" content="Agency Master Dashboard" />
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind (using local for speed if available) -->
    <link rel="stylesheet" href="/src/index.css" /> 
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <style>
      [x-cloak] { display: none !important; }
      
      body {
        font-family: 'Inter', sans-serif;
        background-color: #050505;
        color: #e5e5e5;
      }
      
      /* Cyberpunk scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #0a0a0a;
      }
      ::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #00f3ff;
      }

      .neon-text-purple {
        text-shadow: 0 0 10px rgba(176, 38, 255, 0.5);
      }
      .neon-text-teal {
        text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
      }
      .neon-border-purple {
        box-shadow: 0 0 5px rgba(176, 38, 255, 0.3);
      }
    </style>
  </head>
  <body x-data="dashboard()" x-init="initDashboard()" class="antialiased min-h-screen flex flex-col overflow-x-hidden selection:bg-teal-500 selection:text-black">
    
    <!-- Header -->
    <header class="border-b border-white/10 bg-black/50 backdrop-blur-md sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <h1 class="text-xl md:text-2xl font-bold tracking-tight text-white">
            EMERGE <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-teal-400">CONTROL TOWER</span>
          </h1>
        </div>
        
        <div class="flex items-center gap-6">
          <div class="hidden md:flex flex-col items-end">
            <div class="text-sm font-mono text-teal-400" x-text="time"></div>
            <div class="text-xs text-zinc-500 uppercase tracking-wider">Dubai Standard Time</div>
          </div>
          
          <div class="flex items-center gap-3 pl-6 border-l border-white/10">
            <div class="relative">
              <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="Founder" class="w-9 h-9 rounded-full ring-2 ring-white/10 bg-zinc-800">
              <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-black"></div>
            </div>
            <div class="hidden sm:block">
              <div class="text-xs font-medium text-white">System Status</div>
              <div class="text-[10px] text-green-400 font-mono uppercase tracking-wide">All Systems Green</div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="flex-1 max-w-7xl w-full mx-auto px-4 py-8 space-y-8">
      
      <!-- Hero KPI Row -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Total MRR -->
        <div class="bg-zinc-900/50 border border-white/5 rounded-xl p-5 hover:border-purple-500/50 transition-colors group relative overflow-hidden">
          <div class="absolute inset-0 bg-gradient-to-br from-purple-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
          <div class="flex justify-between items-start mb-2">
            <h3 class="text-zinc-500 text-xs uppercase tracking-wider font-semibold">Total MRR</h3>
            <span class="text-green-400 text-xs font-mono flex items-center gap-1">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
              <span x-text="kpi.mrrChange"></span>
            </span>
          </div>
          <div class="text-3xl font-bold text-white tracking-tight mb-1" x-text="kpi.mrr"></div>
          <div class="text-xs text-zinc-600">Monthly Recurring Revenue</div>
        </div>

        <!-- Profit Today -->
        <div class="bg-zinc-900/50 border border-white/5 rounded-xl p-5 hover:border-teal-500/50 transition-colors group relative overflow-hidden">
          <div class="absolute inset-0 bg-gradient-to-br from-teal-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
          <div class="flex justify-between items-start mb-2">
            <h3 class="text-zinc-500 text-xs uppercase tracking-wider font-semibold">Profit Today</h3>
          </div>
          <div class="text-3xl font-bold text-white tracking-tight mb-1" x-text="kpi.profit"></div>
          <div class="text-xs text-zinc-600">Net profit after expenses</div>
        </div>

        <!-- Active Pods -->
        <div class="bg-zinc-900/50 border border-white/5 rounded-xl p-5 hover:border-blue-500/50 transition-colors group relative overflow-hidden">
           <div class="flex justify-between items-start mb-2">
            <h3 class="text-zinc-500 text-xs uppercase tracking-wider font-semibold">Active Pods</h3>
            <span class="h-2 w-2 rounded-full bg-green-500 animate-pulse"></span>
          </div>
          <div class="text-3xl font-bold text-white tracking-tight mb-1">3<span class="text-zinc-600 text-xl font-normal">/5</span></div>
          <div class="text-xs text-zinc-600">Operational capacity at 60%</div>
        </div>

        <!-- AI Output -->
        <div class="bg-zinc-900/50 border border-white/5 rounded-xl p-5 hover:border-pink-500/50 transition-colors group relative overflow-hidden">
           <div class="flex justify-between items-start mb-2">
            <h3 class="text-zinc-500 text-xs uppercase tracking-wider font-semibold">AI Output</h3>
          </div>
          <div class="text-3xl font-bold text-white tracking-tight mb-1" x-text="kpi.aiOutput"></div>
          <div class="text-xs text-zinc-600">Pieces generated today</div>
        </div>
      </div>

      <!-- Pod Health Cards -->
      <div>
        <h2 class="text-sm font-semibold text-zinc-400 mb-4 uppercase tracking-wider flex items-center gap-2">
          <span class="w-1.5 h-1.5 rounded-full bg-purple-500"></span> Pod Health
        </h2>
        <div class="overflow-x-auto pb-4 -mx-4 px-4 md:overflow-visible md:pb-0 md:mx-0 md:px-0">
            <div class="flex md:grid md:grid-cols-3 gap-4 w-max md:w-full">
                <template x-for="pod in pods" :key="pod.name">
                    <div class="w-72 md:w-auto bg-black border border-white/10 rounded-lg p-4 shrink-0 flex flex-col gap-3 hover:border-white/20 transition-colors">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-bold text-white" x-text="pod.name"></div>
                                <div class="text-xs text-zinc-500" x-text="pod.vertical"></div>
                            </div>
                            <div class="relative w-10 h-10 flex items-center justify-center">
                                <svg class="w-full h-full transform -rotate-90">
                                    <circle cx="20" cy="20" r="16" stroke="#333" stroke-width="3" fill="none"></circle>
                                    <circle cx="20" cy="20" r="16" :stroke="getHealthColor(pod.health)" stroke-width="3" fill="none" stroke-dasharray="100" :stroke-dashoffset="100 - pod.health"></circle>
                                </svg>
                                <span class="absolute text-[10px] font-mono" x-text="pod.health"></span>
                            </div>
                        </div>
                        <div class="flex justify-between items-end mt-2">
                            <div>
                                <div class="text-[10px] text-zinc-500 uppercase">MRR</div>
                                <div class="text-sm font-mono text-white" x-text="pod.mrr"></div>
                            </div>
                             <div class="flex flex-col items-end w-1/2">
                                <div class="text-[10px] text-zinc-500 uppercase mb-1">Profit Margin</div>
                                <div class="h-1.5 w-full bg-zinc-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-purple-600 to-teal-400" :style="`width: ${pod.margin}%`"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          
          <!-- Upcoming Phase Changes -->
          <div class="lg:col-span-1">
               <h2 class="text-sm font-semibold text-zinc-400 mb-4 uppercase tracking-wider flex items-center gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-teal-500"></span> Phase Changes
              </h2>
              <div class="space-y-3">
                  <template x-for="phase in phases" :key="phase.client">
                      <div class="bg-zinc-900/30 border-l-2 border-teal-500/50 pl-4 py-2">
                          <div class="flex justify-between items-center mb-1">
                              <span class="text-sm font-medium text-white" x-text="phase.client"></span>
                              <span class="text-xs font-mono text-teal-400" x-text="phase.countdown"></span>
                          </div>
                          <div class="flex items-center gap-2 text-xs text-zinc-500">
                              <span x-text="phase.oldPrice"></span>
                              <span class="text-zinc-700">→</span>
                              <span class="text-white font-medium" x-text="phase.newPrice"></span>
                          </div>
                          <div class="text-[10px] text-zinc-600 mt-1" x-text="phase.date"></div>
                      </div>
                  </template>
              </div>
          </div>

          <!-- Approval Queue -->
          <div class="lg:col-span-2">
               <h2 class="text-sm font-semibold text-zinc-400 mb-4 uppercase tracking-wider flex items-center gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span> Approval Queue
              </h2>
              <div class="space-y-3">
                  <template x-for="item in queue" :key="item.id">
                      <div class="flex items-center gap-4 bg-zinc-900/50 border border-white/5 p-3 rounded-lg hover:bg-zinc-900 transition-colors">
                          <div class="w-12 h-12 bg-zinc-800 rounded overflow-hidden shrink-0 relative group cursor-pointer">
                              <img :src="item.thumbnail" class="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition-opacity">
                              <div class="absolute inset-0 flex items-center justify-center bg-black/50 opacity-0 group-hover:opacity-100">
                                  <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                              </div>
                          </div>
                          <div class="flex-1 min-w-0">
                              <div class="flex items-center gap-2">
                                  <h4 class="text-sm font-medium text-white truncate" x-text="item.client"></h4>
                                  <span class="text-[10px] px-1.5 py-0.5 rounded bg-zinc-800 text-zinc-400" x-text="item.type"></span>
                              </div>
                              <p class="text-xs text-zinc-500 truncate mt-0.5">Submitted by <span x-text="item.author"></span> • <span x-text="item.timeAgo"></span></p>
                          </div>
                          <div class="flex items-center gap-2">
                               <button @click="approve(item.id)" class="p-2 rounded hover:bg-green-500/10 text-zinc-400 hover:text-green-400 transition-colors" title="Approve">
                                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                               </button>
                               <button @click="reject(item.id)" class="p-2 rounded hover:bg-red-500/10 text-zinc-400 hover:text-red-400 transition-colors" title="Reject">
                                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                               </button>
                          </div>
                      </div>
                  </template>
                  <div x-show="queue.length === 0" class="text-center py-8 text-zinc-600 text-sm">
                      All caught up! No items pending approval.
                  </div>
              </div>
          </div>
      </div>

      <!-- Red Flags -->
      <div class="bg-red-950/10 border border-red-900/20 rounded-xl p-6">
           <h2 class="text-sm font-semibold text-red-400 mb-4 uppercase tracking-wider flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                Critical Alerts
           </h2>
           <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
               <template x-for="alert in alerts" :key="alert.id">
                   <div class="flex gap-3 items-start">
                       <div class="w-1.5 h-1.5 rounded-full bg-red-500 mt-2 shrink-0"></div>
                       <div>
                           <div class="text-sm font-medium text-red-200" x-text="alert.title"></div>
                           <div class="text-xs text-red-500/70 mt-0.5" x-text="alert.desc"></div>
                       </div>
                   </div>
               </template>
           </div>
      </div>

    </main>

    <footer class="border-t border-white/5 py-6 mt-auto">
        <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4 text-xs text-zinc-600">
            <div>Emerge Digital © 2026</div>
            <div class="font-mono">Built on Replit • v2.4.0-alpha</div>
        </div>
    </footer>

    <script>
      function dashboard() {
        return {
          time: '',
          kpi: {
            mrr: '$0',
            mrrChange: '+0%',
            profit: '$0',
            aiOutput: '0'
          },
          pods: [],
          phases: [],
          queue: [],
          alerts: [],
          
          async initDashboard() {
            this.updateTime();
            setInterval(() => this.updateTime(), 1000);
            
            // Load initial data
            await this.loadData();
            
            // Refresh data every 10 seconds
            setInterval(() => this.loadData(), 10000);
          },
          
          async loadData() {
            try {
              await Promise.all([
                this.loadKpis(),
                this.loadPods(),
                this.loadPhaseChanges(),
                this.loadApprovals(),
                this.loadAlerts()
              ]);
            } catch (error) {
              console.error('Error loading data:', error);
            }
          },

          async loadKpis() {
            const response = await fetch('/api/kpis');
            const data = await response.json();
            if (data) {
              this.kpi = {
                mrr: '$' + parseFloat(data.mrr).toLocaleString('en-US', { maximumFractionDigits: 0 }),
                mrrChange: '+' + parseFloat(data.mrrChange).toFixed(1) + '%',
                profit: '$' + parseFloat(data.profitToday).toLocaleString('en-US', { maximumFractionDigits: 0 }),
                aiOutput: data.aiOutputToday.toLocaleString()
              };
            }
          },

          async loadPods() {
            const response = await fetch('/api/pods');
            const data = await response.json();
            this.pods = data.map(pod => ({
              id: pod.id,
              name: pod.name,
              vertical: pod.vertical,
              mrr: '$' + (parseFloat(pod.mrr) / 1000).toFixed(0) + 'k',
              health: pod.health,
              margin: pod.margin
            }));
          },

          async loadPhaseChanges() {
            const response = await fetch('/api/phase-changes');
            const data = await response.json();
            this.phases = data.map(phase => {
              const changeDate = new Date(phase.changeDate);
              const now = new Date();
              const daysLeft = Math.ceil((changeDate - now) / (1000 * 60 * 60 * 24));
              
              return {
                id: phase.id,
                client: phase.client,
                oldPrice: '$' + (parseFloat(phase.oldPrice) / 1000).toFixed(0) + 'k',
                newPrice: '$' + (parseFloat(phase.newPrice) / 1000).toFixed(0) + 'k',
                date: changeDate.toLocaleDateString('en-US', { month: 'short', day: '2-digit' }),
                countdown: daysLeft > 0 ? daysLeft + 'd left' : 'Today'
              };
            });
          },

          async loadApprovals() {
            const response = await fetch('/api/approvals');
            const data = await response.json();
            this.queue = data.map(item => {
              const createdAt = new Date(item.createdAt);
              const now = new Date();
              const minutesAgo = Math.floor((now - createdAt) / (1000 * 60));
              
              let timeAgo;
              if (minutesAgo < 60) {
                timeAgo = minutesAgo + 'm ago';
              } else {
                const hoursAgo = Math.floor(minutesAgo / 60);
                timeAgo = hoursAgo + 'h ago';
              }
              
              return {
                id: item.id,
                client: item.client,
                type: item.type,
                author: item.author,
                thumbnail: item.thumbnail,
                timeAgo
              };
            });
          },

          async loadAlerts() {
            const response = await fetch('/api/alerts');
            const data = await response.json();
            this.alerts = data.map(alert => ({
              id: alert.id,
              title: alert.title,
              desc: alert.description
            }));
          },
          
          updateTime() {
            // Dubai is UTC+4
            const d = new Date();
            // Get UTC time and add 4 hours
            const utc = d.getTime() + (d.getTimezoneOffset() * 60000);
            const dubaiTime = new Date(utc + (3600000 * 4));
            
            this.time = dubaiTime.toLocaleTimeString('en-US', { 
              hour: '2-digit', 
              minute: '2-digit', 
              second: '2-digit',
              hour12: true 
            });
          },

          getHealthColor(score) {
              if (score >= 95) return '#10b981'; // Green
              if (score >= 85) return '#f59e0b'; // Amber
              return '#ef4444'; // Red
          },

          async approve(id) {
             try {
               await fetch(`/api/approvals/${id}/approve`, { method: 'POST' });
               this.queue = this.queue.filter(item => item.id !== id);
             } catch (error) {
               console.error('Error approving item:', error);
             }
          },
          
          async reject(id) {
             try {
               await fetch(`/api/approvals/${id}/reject`, { method: 'POST' });
               this.queue = this.queue.filter(item => item.id !== id);
             } catch (error) {
               console.error('Error rejecting item:', error);
             }
          }
        }
      }
    </script>
  </body>
</html>